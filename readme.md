# Traffic Signal Controller (4-Lane) with YOLO Vehicle Detection

An educational traffic signal controller and simulation that uses a YOLO model to detect vehicles from images and drive a 4-lane intersection simulation. The project includes a Streamlit web interface (`app.py`) to upload images for each lane and export detections to `detected_vehicles.json`, and Pygame-based simulations (`simulation.py`, `simulation_static_time.py`) that consume the detection output.

## Features

- Vehicle detection using Ultralytics YOLO (model file: `best.pt`)
- Streamlit UI for uploading multiple images per lane and viewing annotated detections
- Export detections to `detected_vehicles.json` for simulation
- Pygame-based traffic simulation with dynamic green time calculation and turning behavior
- Images for vehicles in `images/vehicles/` used to render sprites

## Repository layout

```
traffic-signal-controller/
├── app.py                      # Streamlit app (UI + detection)
├── best.pt                     # YOLO model (must be present for detection)
├── detected_vehicles.json      # Generated by app.py (ignored by git)
├── simulation.py               # Pygame traffic simulation (dynamic timing)
├── simulation_static_time.py   # Pygame simulation with static timing
├── requirements.txt            # Python packages (pinned)
├── packages.txt                # Linux system packages (for Debian/Ubuntu)
├── images/                     # Graphics and vehicle images
│   ├── vehicles/               # vehicle images used by simulation
│   └── signals/                # traffic light icons
├── run.ps1                     # Optional PowerShell helper (may be present)
├── .gitignore                  # Git ignore (includes detected_vehicles.json)
└── README.md                   # This file
```

## Prerequisites

- Python 3.9 - 3.11 (recommended)
- On Windows: Anaconda/Miniconda or a system Python installation
- For GPU acceleration: a compatible NVIDIA driver + CUDA and a matching PyTorch wheel

Note: `packages.txt` lists Linux system deps (`libgl1-mesa-glx`, `libglib2.0-0`). On Windows you don't need those; ensure Visual C++ redistributable if you hit binary extension errors.

## Setup (recommended)

Option A — Using Conda (recommended for ML dev):

# Create environment with Python 3.11
conda create -n traffic-controller python=3.11 -y
conda activate traffic-controller

# Install requirements (CPU recommended)
pip install --upgrade pip
# Optional: install CPU-only PyTorch first to avoid CUDA mismatches
python -m pip install --index-url https://download.pytorch.org/whl/cpu torch torchvision
pip install -r requirements.txt
```

Option B — Using venv:

```powershell
# From project root
python -m venv .venv
.\.venv\Scripts\Activate
python -m pip install --upgrade pip setuptools wheel
# Install CPU PyTorch then requirements
python -m pip install --index-url https://download.pytorch.org/whl/cpu torch torchvision
python -m pip install -r requirements.txt
```

If you need GPU support, install the correct PyTorch wheel for your CUDA version first (see https://pytorch.org/get-started/locally/) and then `pip install -r requirements.txt`.

## Run the Streamlit App (vehicle detection)

```powershell
# Activate your environment (conda or venv)
# Then run:
streamlit run app.py
```

Open the URL Streamlit prints (usually `http://localhost:8501`) in your browser. Upload images for each lane, review annotated outputs, then click **Save & Send to Simulation** to write `detected_vehicles.json`.

## Run the Simulation

After saving detections from the web UI, run the Pygame simulation (it reads `detected_vehicles.json` by default):

```powershell
python simulation.py
# or static timing:
python simulation_static_time.py
```

Behavior:
- Vehicles are created from `detected_vehicles.json` and placed into lanes.
- A portion of vehicles are randomly assigned to turn at the intersection (configurable in code).
- Vehicles use images in `images/vehicles/`. Missing classes fall back to similar images or a gray rectangle.
- Vehicles that exit the visible area are automatically removed.

## Important Files & Settings

- `best.pt` — required for detection. If missing, the Streamlit app will warn and not perform detection.
- `detected_vehicles.json` — produced by `app.py`; intentionally gitignored to avoid committing generated data.
- `requirements.txt` — pinned packages. If you hit install errors, prefer using Conda or installing `torch`/`torchvision` manually first.

## Tips & Troubleshooting

- If `conda` is not recognized in PowerShell, run the Anaconda installer and then initialize shell support: `conda init powershell`, then restart the terminal.
- If you see "No such file: 'best.pt'": place your YOLO model in the project root named `best.pt` or change the path in `app.py`.
- If `pip install -r requirements.txt` fails due to `numpy` or wheel issues, create a conda environment with Python 3.11 and install via conda/pip there.
- If images are oriented incorrectly, the simulation code applies rotations assuming vehicle images face "up"; adjust rotation angles in `simulation.py`/`simulation_static_time.py`.

## Customization

- Turn probability: change the creation logic in `create_vehicles_from_detections()` in the simulation files. Default is 30%.
- Detection confidence threshold: edit the `conf` parameter in `app.py`'s `model.predict(..., conf=0.5)` call.
- Change lane mapping or vehicle speed in `simulation.py` constants near the top of the file.

## License

Educational / Research project - use as you like, attribute the author where appropriate.

---

If you'd like, I can also:
- Add a short `run.ps1` to automate the venv/requirements/start steps (PowerShell)
- Create a Dockerfile for reproducible runs
- Add unit tests for the simulation utilities

If you want any of the above, tell me which and I'll add it.
set the max timer for each green signal